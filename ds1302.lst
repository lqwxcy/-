C51 COMPILER V9.00   DS1302                                                                05/31/2013 22:02:17 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\output\ds1302.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE src\ds1302.c BROWSE DEBUG OBJECTEXTEND PRINT(.\output\ds1302.lst) OBJECT(.\
                    -output\ds1302.obj)

line level    source

   1          /*********************************************************** 
   2          ÎÄ¼þÃû³Æ£º DS1302Çý¶¯³ÌÐò
   3          ×÷ Õß£º    ÁºÈ¨Íþ
   4          °æ ±¾£º    0.01
   5          Ëµ Ã÷£º    
   6          Ê±¼ä £º    2012Äê12ÔÂ13ÈÕ21:33:45
   7          ÐÞ¸Ä¼ÇÂ¼£º
   8          ×Ü½á £º         
   9          ***********************************************************/
  10          #include"ds1302.h"
  11          #include<intrins.h>
  12          
  13          /*------------------------------------------
  14                  DS1302¿ØÖÆ¹Ü½Å¶¨Òå
  15          -------------------------------------------*/
  16          sbit SCL = P2^4;  //Ê±ÖÓÏß
  17          sbit IO  = P2^5;  //Êý¾ÝÏß
  18          sbit RST = P2^6;  //¸´Î»Ïß
  19          
  20          /*------------------------------------------
  21                  ¶¨Òå²Ù×÷±äÁ¿
  22          -------------------------------------------*/
  23          u8 DataTime[ 7 ] = {40,1,21,26,12,4,12}; //Ëù¶ÁÈ¡µÄÈÕÆÚÊ±¼ä; //0µ½6·Ö±ðµÍ±í Ãë ·Ö£¬Ê±£¬ÈÕ£¬ÔÂ£¬ÐÇÆÚ£¬Äê
  24          
  25          
  26          /*********************************************************** 
  27          º¯ÊýÃû³Æ£º       void Write_A_Byte_DS1302( u8 dat )
  28          º¯Êý¹¦ÄÜ£º       Ð´Ò»¸ö×Ö½Úµ½ds1302                
  29          Èë¿Ú²ÎÊý£º       dat ÊÇÏëÐ´µÄÊý¾Ý 
  30          ³ö¿Ú²ÎÊý£º        
  31          ±¸ ×¢£º 
  32          ***********************************************************/
  33          void Write_A_Byte_DS1302( u8 dat )
  34          {
  35   1              u8 i;
  36   1              for( i = 0; i < 8; i++ )
  37   1              {
  38   2                      if( dat & 0x01 )//Êý¾Ý´«ËÍÊÇ´ÓµÍÎ»¿ªÊ¼´«ËÍµÄ£¬ÅÐ¶Ï×îµÍÎ»ÊÇ·ñÎª1£¬Îª1Êý¾ÝÏßÉÏµÄÊý¾Ý¾ÍÎª1
  39   2                      {
  40   3                              IO = 1;
  41   3                      }
  42   2                      else
  43   2                      {
  44   3                              IO = 0;    //·ñÔòÎª0
  45   3                      }
  46   2                      SCL = 1;  //Êý¾ÝÔÚ¸ßµçÆ½Ê±£¬±£³Ö
  47   2                      SCL = 0;  //Êý¾ÝÔÚµÍµçÆ½Ê±£¬´«ËÍ
  48   2                      dat = dat >> 1;
  49   2              }               
  50   1      }
  51          
  52          /*********************************************************** 
  53          º¯ÊýÃû³Æ£º       void Write_DS1302_Dat( u8 add, u8 dat )
  54          º¯Êý¹¦ÄÜ£º       Ð´Ë«×Ö½ÚÊý¾Ýµ½ds1302              
C51 COMPILER V9.00   DS1302                                                                05/31/2013 22:02:17 PAGE 2   

  55          Èë¿Ú²ÎÊý£º       addÊÇÏëÐ´µÄµØÖ· dat ÊÇÏëÐ´µÄÊý¾Ý 
  56          ³ö¿Ú²ÎÊý£º        
  57          ±¸ ×¢£º 
  58          ***********************************************************/
  59          void Write_DS1302_Dat( u8 add, u8 dat )
  60          {
  61   1              SCL = 0;
  62   1              RST = 0;
  63   1              RST = 1;
  64   1              Write_A_Byte_DS1302( add );//°ÑµØÖ·Ð´½øds1302
  65   1              Write_A_Byte_DS1302( dat );//°ÑÊý¾ÝÐ´½øds1302
  66   1              SCL = 0;
  67   1              SCL = 1;
  68   1              RST = 0;
  69   1      }
  70          
  71          /*********************************************************** 
  72          º¯ÊýÃû³Æ£º       u8 Read_A_Byte_From_DS1302()
  73          º¯Êý¹¦ÄÜ£º       ´ÓDS1302ÖÐ¶ÁÈ¡Êý¾Ý                
  74          Èë¿Ú²ÎÊý£º       
  75          ³ö¿Ú²ÎÊý£º       dat ÊÇ¶ÁÈ¡µÄÊý¾Ý
  76          ±¸ ×¢£º          ×¢ÒâelseÊÇ&ÉÏ0x7f¶ø²»ÊÇ|£¨»ò£©
  77          ***********************************************************/
  78          u8 Read_A_Byte_From_DS1302()
  79          {
  80   1              u8 i;
  81   1              u8 dat;
  82   1              for( i = 0; i < 8; i++ )
  83   1              {
  84   2                      dat = dat >> 1;
  85   2                      if( IO )
  86   2                      {
  87   3                              dat |= 0x80;//Èç¹û¶Áµ½µÄÊý¾ÝÊÇ1£¬¸ßÎ»±»1£¨ÒòÎªÊý¾ÝÓÒÒÆ£¬¸ßÎ»Òª²¹0£¬Èç¹û²»ºÍ0x80»ò£¬ÔòÊý¾ÝÓÀÔ¶¶¼ÊÇ0£©            
  88   3                      }
  89   2                      else
  90   2                      {
  91   3                              dat &= 0x7f; //·ñÔò²¹0
  92   3                      }
  93   2                      SCL = 1;
  94   2                      SCL = 0; //Êý¾ÝÔÚµÍµçÆ½Ê±ºò´«ËÍÊý¾Ý
  95   2              }
  96   1              return dat;
  97   1      }
  98          
  99          /*********************************************************** 
 100          º¯ÊýÃû³Æ£º       u8 Read_DS1302_ADD_Dat( u8 add )
 101          º¯Êý¹¦ÄÜ£º       ÏÈ°ÑµØÖ·Ð´½øÈ¥ds1302£¬ÔÙ´ÓÄÇ¸öµØÖ·ÀïÃæ¶ÁÈ¡Êý¾Ý·µ»Ø¸øÒ»¸ö±äÁ¿      
 102          Èë¿Ú²ÎÊý£º       add  ´ÓÕâ¸öµØÖ·¶ÁÈ¡Êý¾Ý
 103          ³ö¿Ú²ÎÊý£º       dat ÊÇËù¶ÁÈ¡µ½µÄÊý¾Ý
 104          ±¸ ×¢£º 
 105          ***********************************************************/
 106          u8 Read_DS1302_ADD_Dat( u8 add )
 107          {
 108   1              u8 dat;
 109   1              RST = 0;
 110   1              SCL = 0;        
 111   1              RST = 1;
 112   1              Write_A_Byte_DS1302( add ); //ÏÈ°ÑµØÖ·Ð´½øÈ¥£¬ÔÙ´ÓÕâ¸öµØÖ·ÀïÃæ¶ÁÈ¡Êý¾Ý
 113   1              dat = Read_A_Byte_From_DS1302();//¶¨ÒåÒ»¸öÁÙÊ±±äÁ¿£¬´æ·ÅËù¶Áµ½µÄÊý¾Ý
 114   1              SCL = 1;
 115   1              RST = 0;
 116   1              return dat;
C51 COMPILER V9.00   DS1302                                                                05/31/2013 22:02:17 PAGE 3   

 117   1      }
 118          
 119          /*********************************************************** 
 120          º¯ÊýÃû³Æ£º       void Init_DS1302()
 121          º¯Êý¹¦ÄÜ£º       ds1302³õÊ¼»¯£¬ÊÇ¶ÔÊ±Ê±¼ä          
 122          Èë¿Ú²ÎÊý£º      
 123          ³ö¿Ú²ÎÊý£º       
 124          ±¸ ×¢£º 
 125          ***********************************************************/
 126          void Init_DS1302()
 127          {
 128   1              u8 i;
 129   1              u8 temp;//¶¨ÒåÒ»¸öÁÙÊ±±äÁ¿£¬×÷ÎªÖÐ¼ä±äÁ¿×ª»»³ÉBCDÂë
 130   1              for( i = 0; i < 7; i++ ) //°ÑÊý¾Ý×ª»»³ÉBCDÂë£¬DS1302²ÅÊ¶±ð
 131   1              {
 132   2                      temp = DataTime[ i ] / 10;       //±ÈÈç°Ñ45×ª»»³É69
 133   2                      DataTime[ i ] = DataTime[ i ] % 10;
 134   2                      DataTime[ i ] = DataTime[ i ] + temp*16;                
 135   2              }
 136   1      
 137   1              Write_DS1302_Dat( 0x8e, 0x00 );//È¥³ýÐ´±£»¤£¨8eÊÇ¿ØÖÆ×Ö½Ú£¬00ÊÇ±£»¤×Ö½Ú£©
 138   1              for( i = 0; i < 7; i++ )
 139   1              {
 140   2                      Write_DS1302_Dat( 0x80 + 2*i, DataTime[ i ]);// DataTime[1]±íÊ¾ÊÇ·Ö£¬µØÖ·ÊÇ0x82; DataTime[3]±íÊ¾ÊÇÊ±£¬µØ
             -Ö·ÊÇ0x84;                                
 141   2              }                                                                                                //Ò»ÏÂ°ÑÃë£¬·Ö£¬Ê±£¬ÈÕ£¬ÔÂ£¬ÐÇÆÚ£¬ÄêÐ´½øds1302
 142   1              Write_DS1302_Dat( 0x8e, 0x80 );//Ð´±£»¤£¨8eÊÇ¿ØÖÆ×Ö½Ú£¬80ÊÇ±£»¤×Ö½Ú£©µ±WP×î¸ßÎ»Îª1Ê±£¬±íÊ¾²»ÄÜ¶ÔÐ¾Æ¬ÈÎºÎ²
             -Ù×÷
 143   1      }
 144          
 145          /*********************************************************** 
 146          º¯ÊýÃû³Æ£º       void GetTime()
 147          º¯Êý¹¦ÄÜ£º       ÉÏÃæµÄ²Ù×÷ÒÑ¾­°ÑÊý¾ÝµØÖ·Ëù´ú±íµÄ±äÁ¿Ð´½øÈ¥DS1302ÀïÃæ£¬Õâ¸öº¯ÊýÊÇ°Ñ±äÁ¿¶ÁÈ¡³öÀ´½øÐÐ²Ù×÷£¨ÏÔÊ¾£
             -©           
 148          Èë¿Ú²ÎÊý£º      
 149          ³ö¿Ú²ÎÊý£º       
 150          ±¸ ×¢£º 
 151          ***********************************************************/
 152          void GetTime()
 153          {
 154   1              u8 i;
 155   1              u8 temp;
 156   1              for( i = 0; i < 7; i++ )
 157   1              {
 158   2                      DataTime[ i ] = Read_DS1302_ADD_Dat( 0x81 + 2*i ); //Ò»ÏÂ°ÑÃë£¬·Ö£¬Ê±£¬ÈÕ£¬ÔÂ£¬ÐÇÆÚ£¬Äê¶ÁÈ¡³öÀ´
 159   2              }
 160   1              for( i = 0; i < 7; i++ )        
 161   1              {
 162   2                      temp = DataTime[ i ] / 16 ;
 163   2                      DataTime[ i ] = DataTime[ i ] % 16;
 164   2                      DataTime[ i ] = DataTime[ i ] + temp*10; //´æ´¢ÔÚDS1302ÀïÃæµÄÊý¾ÝÊÇBCDÂë£¬¶ÁÈ¡³öÀ´£¬Òª×ª»»³ÉÊ®½øÖÆ²ÅÄÜÏÔ
             -Ê¾
 165   2              }       
 166   1      }
 167          
 168          /*********************************************************** 
 169          º¯ÊýÃû³Æ£º       void Format_Time( u8 dat, u8 *s )
 170          º¯Êý¹¦ÄÜ£º       ÈÕÆÚÓëÊ±¼äÖµ×ª»»ÎªÊý×Ö×Ö·û        
 171          Èë¿Ú²ÎÊý£º      
 172          ³ö¿Ú²ÎÊý£º       
 173          ±¸ ×¢£º 
 174          ***********************************************************/
C51 COMPILER V9.00   DS1302                                                                05/31/2013 22:02:17 PAGE 4   

 175          void Format_Time( u8 dat, u8 *s )
 176          {
 177   1              s[ 0 ] = dat / 10 + '0';
 178   1              s[ 1 ] = dat % 10 + '0';        
 179   1      }
 180          
 181          /*********************************************************** 
 182          º¯ÊýÃû³Æ£º       void Init_DS1302()
 183          º¯Êý¹¦ÄÜ£º       ds1302³õÊ¼»¯£¬ÊÇ¶ÔÊ±Ê±¼ä          
 184          Èë¿Ú²ÎÊý£º      
 185          ³ö¿Ú²ÎÊý£º       
 186          ±¸ ×¢£º 
 187          ***********************************************************/
 188          /*
 189          void Init_DS1302()
 190          {
 191                  SCL = 0;
 192                  RST = 0;
 193                  Write_DS1302_Dat( 0x80, 0x00 );         
 194          }
 195          */
 196          
 197          
 198          
 199          
 200          
 201          
 202          
 203          
 204          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    244    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
